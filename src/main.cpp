#include <Arduino.h>
#include <math.h>

float fuel;
int ign;

int throttle_list[16] = {1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16};
int rpm_list[20] = {500,1000,1500,2000,2500,3000,4000,5000,6000,7000,8000,8500,9000,9500,10000,10500,11000,11500,12000,12500};

float fuel_LUT[16][20] = {
10,9.8,9.6,9.4,9.2,9,8.8,8.6,8.4,8.6,9,9.4,9.8,10,9.8,9.6,9.4,9.2,9,8.8,
7.938,7.776,7.614,7.452,7.29,7.128,6.966,6.804,6.642,6.804,7.128,7.452,9.6,9.8,9.6,9.4,9.2,9,8.8,8.6,
8.554,8.375,8.197,8.019,7.841,7.663,7.484,7.306,7.128,7.306,7.663,8.019,9.4,9.6,9.4,9.2,9,8.8,8.6,8.4,
8.375,8.197,8.019,7.841,7.663,7.484,7.306,7.128,6.95,7.128,7.484,7.841,9.2,9.4,9.2,9,8.8,8.6,8.4,8.2,
8.197,8.019,7.841,7.663,7.484,7.306,7.128,6.95,6.772,6.95,7.306,7.663,8.8,8.8,8.6,8.4,8.2,8,7.8,7.6,
8.019,7.841,7.663,7.484,7.306,7.128,6.95,6.772,6.593,6.593,6.95,7.306,8.4,8.4,8.2,8,7.8,7.6,7.4,7.2,
7.841,7.663,7.484,7.306,7.128,6.95,6.772,6.593,6.415,6.415,6.772,7.128,8.2,8.2,8,7.8,7.6,7.4,7.2,7,
7.663,7.484,7.306,7.128,6.95,6.772,6.593,6.415,6.237,6.059,6.059,6.415,7.4,7.4,7.2,7,6.8,6.6,6.4,6.2,
7.484,7.306,7.128,6.95,6.772,6.593,6.415,6.237,6.059,6.059,5.881,5.881,6.8,6.8,6.6,6.4,6.2,6,5.8,5.6,
7.306,7.128,6.95,6.772,5.934,5.774,5.613,5.453,5.881,5.881,5.702,5.702,6.4,6.4,6.2,6,5.8,5.6,5.4,5.2,
7.128,6.95,6.772,6.593,5.774,5.613,5.453,5.292,5.702,5.702,5.524,5.524,6.2,6.2,6,5.8,5.6,5.4,5.2,5,
6.95,6.772,6.593,6.415,5.613,5.453,5.292,5.133,5.524,5.524,5.346,5.346,6,6,5.8,5.6,5.4,5.2,5,4.8,
7.139,6.95,7.391,8.168,7.139,6.929,5.987,5.524,5.94,5.94,5.742,5.742,5.8,5.8,5.6,5.4,5.2,5,4.8,4.6,
6.449,6.235,6.819,7.572,7.349,7.127,5.859,5.4,5.8,5.8,5.6,5.6,5.6,5.6,5.4,5.2,5,4.8,4.6,4.4,
5.762,5.559,6.065,7.349,7.127,6.906,5.67,5.22,5.6,5.6,5.4,5.4,5.4,5.4,5.2,5,4.8,4.6,4.4,4.2,
5.591,5.388,5.59,7.127,7.673,7.425,6.09,5.6,5.4,5.4,5.2,5.2,5.2,5.2,5,4.8,4.6,4.4,4.2,4
};

int ignition_LUT[16][20] = {
10,10,12,14,18,22,26,28,30,32,32,32,32,32,32,32,32,32,32,32,
10,10,12,14,18,22,26,28,30,32,32,32,32,32,32,32,32,32,32,32,
10,10,12,14,18,22,26,28,30,32,32,32,32,32,32,32,32,32,32,32,
10,10,12,14,18,22,26,28,30,32,32,32,32,32,32,32,32,32,32,32,
10,10,12,14,20,24,28,30,32,34,34,34,34,34,34,34,34,34,34,34,
10,10,12,16,22,26,30,30,32,34,34,34,34,34,34,34,34,34,34,34,
10,10,12,14,20,24,28,30,32,34,34,34,34,34,34,34,34,34,34,34,
10,10,12,14,20,24,28,30,32,34,34,34,34,34,34,34,34,34,34,34,
10,10,12,14,20,24,28,30,32,34,34,34,34,34,34,34,34,34,34,34,
10,10,12,14,20,24,28,30,32,34,34,34,34,34,34,34,34,34,34,34,
10,10,12,14,20,24,28,30,32,34,34,34,34,34,34,34,34,34,34,34,
10,10,12,14,18,22,26,28,30,32,32,32,32,32,32,32,32,32,32,32,
9,10,11,14,18,22,26,28,30,32,32,32,32,32,32,32,32,32,32,32,
9,10,11,14,18,20,24,26,28,30,30,30,30,30,30,30,30,30,30,30,
9,10,11,14,18,18,22,24,26,28,28,28,28,28,28,28,28,28,28,28,
9,10,11,14,18,18,22,22,24,26,26,26,26,26,26,26,26,26,26,26
};

float fuel_lookup(float, int);    //returns fuel injection timing
int ignition_lookup(float, int);  //returns ignition timing
void calc_rpm();

void setup() {
  
}

void loop() {
  
}

float fuel_lookup(int throttle, int rpm){
  //locate the values 
  int t, r;
  for(int i=0;i<16;i++)
  {
    if(throttle>=throttle_list[i] && throttle<=throttle_list[i+1])
    {
      t = i;
      break;
    }
  }
  for(int i=0;i<20;i++)
  {
    if(rpm>=rpm_list[i] && rpm<=rpm_list[i+1])
    {
      r = i;
      break;
    }
  }

  //perform weighted linear interpolation 
  //putting the point on a plane 
  int r1 = rpm_list[r];
  int r2 = rpm_list[r+1];
  int t1 = throttle_list[t];
  int t2 = throttle_list[t+1];
  float z11 = fuel_LUT[t][r];
  float z12 = fuel_LUT[t][r+1];
  float z22 = fuel_LUT[t+1][r+1];

  float z = z12*((rpm-r1)*(throttle-t2) - (rpm-r2)*(throttle-t1))/((r2-r1)*(t2-t1)) + z22*(rpm-r1)/(r2-r1) + z11*(t2-throttle)/(t2-t1);

  return z;

}

int ignition_lookup(int throttle, int rpm){
  //locate the values 
  int t, r;
  for(int i=0;i<16;i++)
  {
    if(throttle>=throttle_list[i] && throttle<=throttle_list[i+1])
    {
      t = i;
      break;
    }
  }
  for(int i=0;i<20;i++)
  {
    if(rpm>=rpm_list[i] && rpm<=rpm_list[i+1])
    {
      r = i;
      break;
    }
  }

  //perform weighted linear interpolation 
  //putting the point on a plane 
  int r1 = rpm_list[r];
  int r2 = rpm_list[r+1];
  int t1 = throttle_list[t];
  int t2 = throttle_list[t+1];
  float z11 = ignition_LUT[t][r];
  float z12 = ignition_LUT[t][r+1];
  float z22 = ignition_LUT[t+1][r+1];

  float z = z12*((rpm-r1)*(throttle-t2) - (rpm-r2)*(throttle-t1))/((r2-r1)*(t2-t1)) + z22*(rpm-r1)/(r2-r1) + z11*(t2-throttle)/(t2-t1);

  return (int)floor(z);

}